From b58e79ca9a93b142dd95acd3a628ca027c2e7313 Mon Sep 17 00:00:00 2001
From: "baojun.luo" <baojun.luo@samsung.com>
Date: Tue, 17 Dec 2019 00:06:01 +0900
Subject: [PATCH 2/4] Updatge network(lwip,sntp) for MT7682 stdk

Change-Id: I345a2fbcdbcc3f1d456d8d5b1265955e319f24f4
Signed-off-by: baojun.luo <43360374+baojunluo@users.noreply.github.com>
---
 kernel/rtos/FreeRTOS/Source/tasks.c    | 2 +-
 middleware/third_party/lwip/module.mk  | 2 ++
 middleware/third_party/sntp/inc/sntp.h | 2 +-
 middleware/third_party/sntp/src/sntp.c | 6 ++++++
 4 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/kernel/rtos/FreeRTOS/Source/tasks.c b/kernel/rtos/FreeRTOS/Source/tasks.c
index acc29ea..c0f9420 100644
--- a/kernel/rtos/FreeRTOS/Source/tasks.c
+++ b/kernel/rtos/FreeRTOS/Source/tasks.c
@@ -3646,7 +3646,7 @@ TCB_t *pxTCB;
 		{
 			/* Is there a space in the array for each task in the system? */
 #if ( configGENERATE_RUN_TIME_STATS == 1 )
-			ulDeltaTotalRunTime = 0;
+			//ulDeltaTotalRunTime = 0;
 #endif
 			if( uxArraySize >= uxCurrentNumberOfTasks )
 			{
diff --git a/middleware/third_party/lwip/module.mk b/middleware/third_party/lwip/module.mk
index 36dbcc0..590ac22 100644
--- a/middleware/third_party/lwip/module.mk
+++ b/middleware/third_party/lwip/module.mk
@@ -89,6 +89,8 @@ CFLAGS += -I$(SOURCE_DIR)/middleware/third_party/lwip/ports/include
 CFLAGS += -I$(SOURCE_DIR)/middleware/third_party/lwip/src/include
 CFLAGS += -I$(SOURCE_DIR)/middleware/third_party/lwip/src/include/lwip
 CFLAGS += -I$(SOURCE_DIR)/middleware/third_party/lwip/src/include/netif
+CFLAGS += -I$(SOURCE_DIR)/middleware/third_party/lwip/src/include/posix
+CFLAGS += -I$(SOURCE_DIR)/middleware/third_party/lwip/src/include/posix/sys
 CFLAGS += -I$(SOURCE_DIR)/middleware/MTK/nvdm/inc
 CFLAGS += -I$(SOURCE_DIR)/middleware/MTK/minicli/inc
 
diff --git a/middleware/third_party/sntp/inc/sntp.h b/middleware/third_party/sntp/inc/sntp.h
index a31c3a5..0a15831 100644
--- a/middleware/third_party/sntp/inc/sntp.h
+++ b/middleware/third_party/sntp/inc/sntp.h
@@ -39,7 +39,7 @@
 extern "C" {
 #endif
 
-#define SNTP_MAX_SERVERS 4
+#define SNTP_MAX_SERVERS 8
 /** The maximum number of SNTP servers that can be set */
 #ifndef SNTP_MAX_SERVERS
 #define SNTP_MAX_SERVERS           LWIP_DHCP_MAX_NTP_SERVERS
diff --git a/middleware/third_party/sntp/src/sntp.c b/middleware/third_party/sntp/src/sntp.c
index 555cd48..cf25160 100644
--- a/middleware/third_party/sntp/src/sntp.c
+++ b/middleware/third_party/sntp/src/sntp.c
@@ -159,6 +159,12 @@
 #define SNTP_SET_SYSTEM_TIME(sec) sntp_set_system_time((sec),0)
 #endif
 
+#define SNTP_SET_SYSTEM_TIME_US(sec, us)  \
+    do { \
+      struct timeval tv = { .tv_sec = sec, .tv_usec = us }; \
+       settimeofday(&tv, NULL); \
+     } while (0);
+
 /** SNTP macro to change system time including microseconds */
 #ifdef SNTP_SET_SYSTEM_TIME_US
 #define SNTP_CALC_TIME_US           1
-- 
2.7.4

